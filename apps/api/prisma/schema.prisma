generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// EXISTING MODELS (updated with relations)
// ============================================

model Applicant {
  id            String        @id @default(cuid())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  firstName     String
  lastName      String
  email         String        @unique
  phone         String?
  rightToWorkUk Boolean?
  applications  Application[]
  
  // NEW: Link to user account (if they register)
  user          User?
}

model Role {
  id           String            @id @default(cuid())
  name         String            @unique
  applications ApplicationRole[]
  
  // NEW: Jobs for this role
  jobs         Job[]
}

model ApplicationRole {
  application     Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  applicationId   String
  role            Role        @relation(fields: [roleId], references: [id])
  roleId          String
  experienceLevel String?

  @@id([applicationId, roleId])
  @@map("ApplicationRole")
}

model Application {
  id             String            @id @default(cuid())
  createdAt      DateTime          @default(now())
  status         ApplicationStatus @default(RECEIVED)
  cvKey          String
  cvOriginalName String?
  cvFileSize     Int?              // file size in bytes
  cvMimeType     String?           // e.g. "application/pdf"
  cvUploadedAt   DateTime?         // when the CV was uploaded
  notes          String?
  source         String?
  applicant      Applicant         @relation(fields: [applicantId], references: [id])
  applicantId    String
  roles          ApplicationRole[]

  @@index([status, createdAt])
}

enum ApplicationStatus {
  RECEIVED
  REVIEWING
  SHORTLISTED
  REJECTED
  HIRED
}

model AdminUser {
  id             String    @id @default(cuid())
  username       String    @unique
  password       String
  createdAt      DateTime  @default(now())
  failedAttempts Int       @default(0)
  lockedUntil    DateTime?
  
  @@index([username])
}
// ============================================
// CLIENT/COMPANY MODELS
// ============================================

// Corporate clients who hire staff
model Client {
  id              String        @id @default(cuid())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Company details
  companyName     String
  industry        String?
  website         String?
  companySize     String?       // e.g. "1-10", "11-50", "51-200", "200+"
  
  // Primary contact
  contactName     String
  email           String        @unique
  passwordHash    String
  phone           String?
  jobTitle        String?       // e.g. "Event Manager", "HR Director"
  
  // Approval workflow
  status          ClientStatus  @default(PENDING)
  approvedAt      DateTime?
  approvedBy      String?       // Admin username who approved
  rejectionReason String?
  
  // Auth
  emailVerified   Boolean       @default(false)
  verifyToken     String?
  verifyTokenExp  DateTime?
  resetToken      String?
  resetTokenExp   DateTime?
  
  // Security
  failedAttempts  Int           @default(0)
  lockedUntil     DateTime?
  lastLoginAt     DateTime?
  
  // Admin notes
  adminNotes      String?       @db.Text
  
  // Relations
  quoteRequests   QuoteRequest[]
  refreshTokens   RefreshToken[]
  
  @@index([email])
  @@index([status])
  @@index([createdAt])
}

// Quote requests from clients
model QuoteRequest {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Event details
  eventType     String    // e.g. "Corporate Event", "Wedding", "Festival"
  eventDate     DateTime?
  eventEndDate  DateTime?
  location      String
  venue         String?
  
  // Staffing requirements
  staffCount    Int
  roles         String    // Comma-separated or JSON
  shiftStart    String?
  shiftEnd      String?
  
  // Additional info
  description   String?   @db.Text
  budget        String?   // Budget range
  
  // Status tracking
  status        String    @default("NEW") // NEW, QUOTED, ACCEPTED, DECLINED, COMPLETED
  adminNotes    String?   @db.Text
  quotedAmount  Decimal?  @db.Decimal(10, 2)
  quoteSentAt   DateTime?
  
  // Relations
  clientId      String
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
}

model Contact {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Contact info
  name        String
  email       String
  phone       String?
  company     String?
  
  // Enquiry details
  type        ContactType
  eventType   String?
  eventDate   DateTime?
  guests      Int?
  staffCount  Int?
  roles       String?       // JSON array or comma-separated
  subject     String?
  message     String        @db.Text
  
  // Status tracking
  status      ContactStatus @default(NEW)
  adminNotes  String?       @db.Text
  
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

enum ContactType {
  EVENT_ENQUIRY
  STAFF_REQUEST
  GENERAL
}

enum ContactStatus {
  NEW
  CONTACTED
  QUOTED
  BOOKED
  LOST
}

enum ClientStatus {
  PENDING     // Awaiting admin approval
  APPROVED    // Can log in and use platform
  REJECTED    // Application denied
  SUSPENDED   // Account suspended
}

model FileUploadVerification {
  id          String   @id @default(uuid())
  key         String   @unique @db.VarChar(500)
  applicantId String   @db.VarChar(36)
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  verified    Boolean  @default(false)
  
  @@index([key])
  @@index([expiresAt])
}

// ============================================
// NEW: JOB BOARD MODELS
// ============================================

// User accounts for job seekers
model User {
  id              String           @id @default(cuid())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Auth
  email           String           @unique
  passwordHash    String
  emailVerified   Boolean          @default(false)
  verifyToken     String?
  verifyTokenExp  DateTime?
  resetToken      String?
  resetTokenExp   DateTime?
  
  // Profile
  firstName       String
  lastName        String
  phone           String?
  
  // User type (JOB_SEEKER or CLIENT)
  userType        UserType         @default(JOB_SEEKER)
  
  // Client/Company fields (only used when userType = CLIENT)
  companyName     String?
  companyWebsite  String?
  vatNumber       String?
  billingAddress  String?
  approvedClient  Boolean          @default(false)
  
  // Link to VERGO roster (if they've applied to join your team)
  applicantId     String?          @unique
  applicant       Applicant?       @relation(fields: [applicantId], references: [id])
  
  // Security
  failedAttempts  Int              @default(0)
  lockedUntil     DateTime?
  lastLoginAt     DateTime?
  
  // Relations
  jobApplications JobApplication[]
  savedJobs       SavedJob[]
  refreshTokens   RefreshToken[]
  
  // Indexes (must be at the end)
  @@index([email])
  @@index([userType])
}

// Refresh tokens for mobile JWT auth
model RefreshToken {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  revokedAt  DateTime?
  tokenHash  String   @unique
  userId     String?
  clientId   String?

  user       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  client     Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([clientId])
  @@index([expiresAt])
}

// Job listings
model Job {
  id            String        @id @default(cuid())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Core info
  title         String
  description   String        @db.Text
  requirements  String?       @db.Text  // What you need from applicants
  
  // Type & Status
  type          JobType       @default(INTERNAL)
  status        JobStatus     @default(DRAFT)
  
  // Location
  location      String        // e.g. "Central London", "O2 Arena"
  venue         String?       // Specific venue name
  
  // Compensation
  payRate       Decimal?      @db.Decimal(10, 2)
  payType       PayType       @default(HOURLY)
  
  // Event/Shift details (primarily for INTERNAL jobs)
  eventDate     DateTime?
  eventEndDate  DateTime?     // For multi-day events
  shiftStart    String?       // e.g. "18:00"
  shiftEnd      String?       // e.g. "02:00"
  
  // Staffing
  staffNeeded   Int           @default(1)
  staffConfirmed Int          @default(0)
  
  // For external jobs
  companyName   String?
  externalUrl   String?       // Link to apply externally
  
  // Publishing
  publishedAt   DateTime?
  closingDate   DateTime?
  
  // Role required
  roleId        String
  role          Role          @relation(fields: [roleId], references: [id])
  
  // Relations
  applications  JobApplication[]
  savedBy       SavedJob[]
  
  @@index([status, type])
  @@index([roleId])
  @@index([eventDate])
  @@index([publishedAt])
}

// When a user applies to a job
model JobApplication {
  id            String               @id @default(cuid())
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  
  status        JobApplicationStatus @default(PENDING)
  
  // Optional message from applicant
  coverNote     String?              @db.Text
  
  // Admin notes (internal)
  adminNotes    String?              @db.Text
  
  // Relations
  userId        String
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  jobId         String
  job           Job                  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  // Prevent duplicate applications
  @@unique([userId, jobId])
  @@index([status])
  @@index([createdAt])
}

// Saved/bookmarked jobs
model SavedJob {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  @@unique([userId, jobId])
}

// ============================================
// ENUMS
// ============================================

enum JobType {
  INTERNAL    // Your VERGO gigs
  EXTERNAL    // Aggregated/partner jobs
}

enum JobStatus {
  DRAFT       // Not visible to users
  OPEN        // Accepting applications
  FILLED      // All positions filled
  CLOSED      // Manually closed/cancelled
}

enum PayType {
  HOURLY
  DAILY
  FIXED       // Fixed fee for the gig
}

enum JobApplicationStatus {
  PENDING     // Awaiting review
  REVIEWED    // Admin has seen it
  SHORTLISTED // Being considered
  CONFIRMED   // Got the job
  REJECTED    // Not selected
  WITHDRAWN   // User cancelled
}


enum UserType {
  JOB_SEEKER
  CLIENT
}

// ============================================
// EMAIL TRACKING MODELS (Phase 3)
// ============================================

// Track sent emails and their delivery status
model Email {
  id        String      @id @default(cuid())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Resend tracking
  resendId  String      @unique

  // Email details
  to        String
  subject   String
  emailType String      // e.g. "user-verification", "job-application-confirmation"

  // Status tracking
  status    EmailStatus @default(QUEUED)

  // Optional associations
  userId    String?
  clientId  String?

  // Events
  events    EmailEvent[]

  @@index([resendId])
  @@index([userId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
}

// Individual email events (sent, delivered, opened, clicked, etc.)
model EmailEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Event details
  eventType String   // e.g. "email.sent", "email.delivered", "email.opened"
  payload   Json?    // Full webhook payload for debugging

  // Relation
  emailId   String
  email     Email    @relation(fields: [emailId], references: [id], onDelete: Cascade)

  @@index([emailId])
  @@index([eventType])
  @@index([createdAt])
}

enum EmailStatus {
  QUEUED
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
  FAILED
}

// ============================================
// EMAIL PREFERENCES (Phase 4)
// ============================================

// User/client email preferences for unsubscribe management
model EmailPreferences {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // One of these will be set
  userId           String?  @unique
  clientId         String?  @unique

  // Preference categories
  marketing        Boolean  @default(true)
  notifications    Boolean  @default(true)
  jobAlerts        Boolean  @default(true)
  quoteUpdates     Boolean  @default(true)

  // Unsubscribe token for one-click unsubscribe
  unsubscribeToken String   @unique @default(cuid())

  @@index([unsubscribeToken])
}

// ============================================
// SCHEDULED EMAILS (Phase 5)
// ============================================

// Track scheduled/delayed emails
model ScheduledEmail {
  id           String               @id @default(cuid())
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  // BullMQ job reference
  jobId        String               @unique

  // Schedule details
  scheduledFor DateTime

  // Status
  status       ScheduledEmailStatus @default(SCHEDULED)

  // Email details
  emailType    String               // e.g. "quote-followup", "shift-reminder"
  recipientId  String               // User or client ID
  subject      String

  // Optional metadata
  metadata     Json?

  @@index([status])
  @@index([scheduledFor])
  @@index([recipientId])
}

enum ScheduledEmailStatus {
  SCHEDULED
  SENT
  CANCELLED
  FAILED
}
