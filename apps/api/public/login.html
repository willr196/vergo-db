<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Login - VERGO Events</title>
  <meta name="description" content="Secure admin login for VERGO Events management system">
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Security Headers (should also be set server-side) -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .login-container {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
    }
    
    h1 {
      margin: 0 0 10px;
      color: #333;
      text-align: center;
      font-size: 1.8rem;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 0.9em;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
      font-size: 0.95rem;
    }
    
    label .required {
      color: #dc3545;
      margin-left: 2px;
    }
    
    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      transition: border-color 0.3s;
      font-family: inherit;
    }
    
    input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    /* Accessible error state */
    input.field-error {
      border-color: #dc3545;
      background-color: #fff5f5;
    }
    
    .field-error-message {
      display: block;
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 6px;
      padding: 6px 10px;
      background: rgba(220, 53, 69, 0.1);
      border-radius: 4px;
      border-left: 3px solid #dc3545;
    }
    
    button {
      width: 100%;
      padding: 14px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      position: relative;
    }
    
    button:hover:not(:disabled) {
      background: #5568d3;
    }
    
    button:focus-visible {
      outline: 3px solid #333;
      outline-offset: 2px;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    button .spinner {
      display: none;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    button:disabled .spinner {
      display: inline-block;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .security-notice {
      margin-top: 20px;
      padding: 12px;
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      border-radius: 4px;
      font-size: 0.85rem;
      color: #666;
    }
    
    .security-notice strong {
      color: #333;
    }
    
    /* Rate limit warning */
    .rate-limit-warning {
      display: none;
      margin-top: 15px;
      padding: 12px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 4px;
      color: #856404;
      font-size: 0.9rem;
    }
    
    .rate-limit-warning.show {
      display: block;
    }
    
    @media (max-width: 480px) {
      .login-container {
        margin: 20px;
        padding: 30px 20px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
  
  <!-- Load accessibility utilities -->
  <link rel="stylesheet" href="/vergo-a11y.css">
</head>
<body>
  <!-- Skip link for accessibility -->
  <a href="#login-form" class="skip-link">Skip to login form</a>
  
  <!-- Screen reader only heading -->
  <h1 class="sr-only">VERGO Events Admin Portal</h1>
  
  <main class="login-container" role="main">
    <h1 id="main-heading">Admin Login</h1>
    <p class="subtitle">VERGO Events Management System</p>
    
    <!-- Security notice -->
    <div class="security-notice">
      <strong>üîí Secure Login:</strong> This is a protected area. All login attempts are logged and monitored.
    </div>
    
    <!-- ARIA live region for form messages -->
    <div id="form-status" role="status" aria-live="polite" class="sr-only"></div>
    
    <form id="login-form" novalidate aria-labelledby="main-heading">
      <div class="form-group">
        <label for="username">
          Username <span class="required" aria-label="required">*</span>
        </label>
        <input 
          type="text"
          id="username"
          name="username" 
          required 
          autocomplete="username"
          autocapitalize="off"
          aria-required="true"
          aria-describedby="username-error"
          maxlength="100"
        />
      </div>
      
      <div class="form-group">
        <label for="password">
          Password <span class="required" aria-label="required">*</span>
        </label>
        <input 
          type="password"
          id="password"
          name="password" 
          required 
          autocomplete="current-password"
          aria-required="true"
          aria-describedby="password-error"
          minlength="8"
        />
      </div>
      
      <!-- Honeypot field (hidden from users, catches bots) -->
      <div style="position: absolute; left: -9999px; opacity: 0;" aria-hidden="true">
        <label for="website">Website (leave blank)</label>
        <input type="text" id="website" name="website" tabindex="-1" autocomplete="off">
      </div>
      
      <!-- Rate limit warning -->
      <div id="rate-limit-warning" class="rate-limit-warning" role="alert">
        <strong>‚ö†Ô∏è Too many attempts.</strong> Please wait <span id="retry-time">60</span> seconds before trying again.
      </div>
      
      <button type="submit" aria-label="Login to admin dashboard">
        <span class="spinner" aria-hidden="true"></span>
        <span id="button-text">Login</span>
      </button>
    </form>
  </main>

  <!-- Load utilities -->
  <script src="/vergo-utils.js"></script>
  
  <script>
    'use strict';
    
    // Configuration
    const MAX_ATTEMPTS = 5;
    const LOCKOUT_DURATION = 60; // seconds
    const STORAGE_KEY = 'vergo_login_attempts';
    
    // State
    let attemptCount = 0;
    let lockoutUntil = null;
    let retryInterval = null;
    
    // Elements
    const form = document.getElementById('login-form');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const submitBtn = form.querySelector('button[type="submit"]');
    const buttonText = document.getElementById('button-text');
    const rateLimitWarning = document.getElementById('rate-limit-warning');
    const retryTimeSpan = document.getElementById('retry-time');
    const formStatus = document.getElementById('form-status');
    
    // Check for existing lockout on page load
    checkLockoutStatus();
    
    // Form submission handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Check if locked out
      if (isLockedOut()) {
        showRateLimitWarning();
        return;
      }
      
      // Validate form
      if (!validateForm()) {
        return;
      }
      
      // Check honeypot
      if (document.getElementById('website').value) {
        console.warn('Bot detected');
        return;
      }
      
      await handleLogin();
    });
    
    // Validation
    function validateForm() {
      let isValid = true;
      
      // Username validation
      if (!usernameInput.value.trim()) {
        showFieldError(usernameInput, 'Username is required');
        isValid = false;
      } else {
        clearFieldError(usernameInput);
      }
      
      // Password validation
      if (!passwordInput.value) {
        showFieldError(passwordInput, 'Password is required');
        isValid = false;
      } else if (passwordInput.value.length < 8) {
        showFieldError(passwordInput, 'Password must be at least 8 characters');
        isValid = false;
      } else {
        clearFieldError(passwordInput);
      }
      
      if (!isValid) {
        updateFormStatus('Please correct the errors in the form');
        // Focus first error
        const firstError = form.querySelector('.field-error');
        if (firstError) firstError.focus();
      }
      
      return isValid;
    }
    
    function showFieldError(field, message) {
      field.classList.add('field-error');
      field.setAttribute('aria-invalid', 'true');
      
      let errorEl = document.getElementById(`${field.id}-error`);
      if (!errorEl) {
        errorEl = document.createElement('div');
        errorEl.id = `${field.id}-error`;
        errorEl.className = 'field-error-message';
        errorEl.setAttribute('role', 'alert');
        field.parentElement.appendChild(errorEl);
      }
      
      errorEl.textContent = message;
    }
    
    function clearFieldError(field) {
      field.classList.remove('field-error');
      field.removeAttribute('aria-invalid');
      
      const errorEl = document.getElementById(`${field.id}-error`);
      if (errorEl) errorEl.remove();
    }
    
    // Login handler
    async function handleLogin() {
      submitBtn.disabled = true;
      buttonText.textContent = 'Signing in...';
      updateFormStatus('Authenticating...');
      
      const credentials = {
        username: usernameInput.value.trim(),
        password: passwordInput.value
      };
      
      try {
        // Use secureFetch with CSRF protection
        const response = await secureFetch('/api/v1/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(credentials)
        });
        
        const contentType = response.headers.get('content-type');
        let data = {};
        
        if (contentType && contentType.includes('application/json')) {
          data = await response.json();
        }
        
        if (response.ok) {
          // Success!
          updateFormStatus('Login successful! Redirecting...');
          notify.show('Login successful!', 'success');
          
          // Clear login attempts
          clearLoginAttempts();
          
          // Redirect after short delay
          setTimeout(() => {
            window.location.href = '/admin.html';
          }, 500);
        } else {
          // Handle errors
          handleLoginError(response, data);
        }
        
      } catch (err) {
        console.error('Login error:', err);
        notify.show('Connection error. Please check your internet and try again.', 'error');
        updateFormStatus('Connection error occurred');
      } finally {
        submitBtn.disabled = false;
        buttonText.textContent = 'Login';
      }
    }
    
    function handleLoginError(response, data) {
      incrementAttempts();
      
      if (response.status === 423) {
        // Account locked
        const lockDuration = data.lockDuration || 900;
        setLockout(lockDuration);
        showRateLimitWarning();
        notify.show(data.error || 'Account temporarily locked', 'error');
        updateFormStatus('Account locked due to too many failed attempts');
      } else if (response.status === 429) {
        // Rate limited
        setLockout(LOCKOUT_DURATION);
        showRateLimitWarning();
        notify.show('Too many attempts. Please wait before trying again.', 'warning');
        updateFormStatus('Rate limit exceeded');
      } else if (response.status === 401) {
        // Invalid credentials
        const remaining = MAX_ATTEMPTS - attemptCount;
        if (remaining > 0) {
          notify.show(`Invalid credentials. ${remaining} attempt${remaining > 1 ? 's' : ''} remaining.`, 'error');
          updateFormStatus(`Invalid username or password. ${remaining} attempts remaining`);
        } else {
          setLockout(LOCKOUT_DURATION);
          showRateLimitWarning();
          notify.show('Account locked due to too many failed attempts', 'error');
          updateFormStatus('Account locked');
        }
        
        // Focus username for retry
        usernameInput.focus();
        usernameInput.select();
      } else {
        // Generic error
        notify.show(data.error || 'Login failed. Please try again.', 'error');
        updateFormStatus('Login failed');
      }
    }
    
    // Attempt tracking
    function incrementAttempts() {
      attemptCount++;
      saveAttempts();
      
      if (attemptCount >= MAX_ATTEMPTS) {
        setLockout(LOCKOUT_DURATION);
      }
    }
    
    function saveAttempts() {
      const data = {
        count: attemptCount,
        timestamp: Date.now()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    
    function loadAttempts() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const data = JSON.parse(stored);
          const age = Date.now() - data.timestamp;
          
          // Reset if attempts are older than 15 minutes
          if (age > 900000) {
            clearLoginAttempts();
            return 0;
          }
          
          return data.count || 0;
        }
      } catch (e) {
        console.error('Error loading attempts:', e);
      }
      return 0;
    }
    
    function clearLoginAttempts() {
      attemptCount = 0;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem('vergo_lockout_until');
    }
    
    // Lockout handling
    function setLockout(seconds) {
      lockoutUntil = Date.now() + (seconds * 1000);
      localStorage.setItem('vergo_lockout_until', lockoutUntil.toString());
      showRateLimitWarning();
    }
    
    function isLockedOut() {
      if (!lockoutUntil) return false;
      return Date.now() < lockoutUntil;
    }
    
    function checkLockoutStatus() {
      attemptCount = loadAttempts();
      
      const storedLockout = localStorage.getItem('vergo_lockout_until');
      if (storedLockout) {
        lockoutUntil = parseInt(storedLockout, 10);
        
        if (isLockedOut()) {
          showRateLimitWarning();
        } else {
          // Lockout expired
          lockoutUntil = null;
          clearLoginAttempts();
        }
      }
    }
    
    function showRateLimitWarning() {
      if (!isLockedOut()) return;
      
      rateLimitWarning.classList.add('show');
      submitBtn.disabled = true;
      
      // Update countdown
      clearInterval(retryInterval);
      retryInterval = setInterval(() => {
        const remaining = Math.ceil((lockoutUntil - Date.now()) / 1000);
        
        if (remaining <= 0) {
          clearInterval(retryInterval);
          rateLimitWarning.classList.remove('show');
          submitBtn.disabled = false;
          lockoutUntil = null;
          clearLoginAttempts();
          updateFormStatus('You may try logging in again');
          notify.show('You may try logging in again', 'info');
        } else {
          retryTimeSpan.textContent = remaining;
        }
      }, 1000);
    }
    
    // Accessibility helper
    function updateFormStatus(message) {
      formStatus.textContent = message;
    }
    
    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      clearInterval(retryInterval);
    });
  </script>
</body>
</html>