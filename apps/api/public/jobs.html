<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/logo-small.png">
  <title>Jobs | VERGO Ltd</title>
  <meta name="description" content="Browse event staffing opportunities in London & surrounding areas. Apply to join the VERGO Ltd team.">
  
  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/vergo-styles.css">
  <link rel="stylesheet" href="/vergo-header.css">
  <link rel="stylesheet" href="/vergo-a11y.css">
  <link rel="stylesheet" href="/vergo-mobile.css">

  <style>
    /* ============================================
     * JOBS PAGE SPECIFIC STYLES
     * ============================================ */

    /* Main Content */
    main {
      padding: 120px 20px 60px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Page Header */
    .page-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .page-header h1 {
      font-size: 2.5rem;
      color: var(--color-text-primary);
      margin-bottom: 10px;
    }
    
    .page-header p {
      color: var(--color-text-muted);
      font-size: 1.1rem;
    }
    
    /* User Bar */
    .user-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 15px 20px;
      background: var(--color-bg-secondary);
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.08);
    }
    
    .user-bar.logged-out {
      justify-content: flex-end;
    }
    
    .user-info {
      color: var(--color-text-muted);
    }
    
    .user-info strong {
      color: var(--color-gold);
    }
    
    .user-actions {
      display: flex;
      gap: 15px;
    }
    
    .btn-small {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      display: block;
      color: var(--color-text-muted);
      font-size: 0.85rem;
      margin-bottom: 5px;
    }
    
    .filter-group select {
      width: 100%;
      padding: 12px 15px;
      background: var(--color-bg-white);
      border: 1px solid rgba(0, 0, 0, 0.12);
      border-radius: 4px;
      color: var(--color-text-primary);
      font-size: 0.95rem;
      cursor: pointer;
    }
    
    .filter-group select:focus {
      outline: none;
      border-color: var(--color-gold);
    }
    
    /* Jobs Grid */
    .jobs-grid {
      display: grid;
      gap: 20px;
    }
    
    .job-card {
      background: var(--color-bg-white);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 8px;
      padding: 25px;
      transition: all 0.3s ease;
    }
    
    .job-card:hover {
      border-color: var(--color-gold);
      transform: translateY(-2px);
    }
    
    .job-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 15px;
    }
    
    .job-title {
      font-size: 1.3rem;
      color: var(--color-text-primary);
      margin-bottom: 5px;
    }
    
    .job-role {
      display: inline-block;
      background: rgba(212, 175, 55, 0.1);
      color: var(--color-gold);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .job-type {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .job-type.internal {
      background: rgba(40, 167, 69, 0.2);
      color: var(--color-success);
    }
    
    .job-type.external {
      background: rgba(0, 123, 255, 0.2);
      color: var(--color-info);
    }
    
    .job-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 15px;
      color: var(--color-text-muted);
      font-size: 0.9rem;
    }
    
    .job-meta span {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .job-description {
      color: var(--color-text-muted);
      line-height: 1.6;
      margin-bottom: 20px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .job-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid rgba(0, 0, 0, 0.08);
    }
    
    .job-pay {
      font-size: 1.1rem;
      color: var(--color-gold);
      font-weight: 600;
    }
    
    .spots-left {
      color: var(--color-text-muted);
      font-size: 0.85rem;
    }
    
    .spots-left.urgent {
      color: var(--color-error);
    }
    
    /* Loading & Empty States */
    .loading, .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--color-text-muted);
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(212, 175, 55, 0.2);
      border-top-color: var(--color-gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .empty-state h3 {
      color: var(--color-text-primary);
      margin-bottom: 10px;
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 40px;
    }
    
    .pagination button {
      padding: 10px 20px;
      background: var(--color-bg-white);
      border: 1px solid rgba(0, 0, 0, 0.12);
      color: var(--color-text-primary);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .pagination button:hover:not(:disabled) {
      border-color: var(--color-gold-hover);
      background: var(--color-bg-secondary);
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination .current {
      color: var(--color-gold);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      main {
        padding: 100px 15px 40px;
      }
      
      .page-header h1 {
        font-size: 1.8rem;
      }
      
      .user-bar {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .filter-group {
        min-width: 100%;
      }
      
      .job-header {
        flex-direction: column;
      }
      
      .job-footer {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
    }
  </style>
  <link rel="stylesheet" href="/vergo-platform.css">
</head>
<body class="platform">
  <a href="#main-content" class="skip-link">Skip to main content</a>
  
<header></header>
  
  <main id="main-content">
    <div class="page-header">
      <h1>Available Jobs</h1>
      <p>Find your next opportunity in London's events industry</p>
    </div>
    
    <!-- User Bar -->
    <div id="user-bar" class="user-bar logged-out">
      <div class="user-actions">
        <a href="user-login" class="btn btn-secondary btn-small">Log In</a>
        <a href="user-register" class="btn btn-primary btn-small">Create Account</a>
      </div>
    </div>
    
    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label>Role</label>
        <select id="filter-role">
          <option value="">All Roles</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Type</label>
        <select id="filter-type">
          <option value="">All Types</option>
          <option value="INTERNAL">VERGO Jobs</option>
          <option value="EXTERNAL">External Jobs</option>
        </select>
      </div>
    </div>
    
    <!-- Jobs List -->
    <div id="jobs-container">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>Loading jobs...</p>
      </div>
    </div>
    
    <!-- Pagination -->
    <div id="pagination" class="pagination" style="display: none;"></div>
  </main>
  
  <!-- Footer -->
  <footer role="contentinfo"></footer>
  
  <script>
    // State
    let currentUser = null;
    let currentPage = 1;
    let totalPages = 1;
    let filters = { roleId: '', type: '' };
    
    // Check auth status
    async function checkAuth() {
      try {
        const res = await fetch('/api/v1/user/session');
        const payload = await res.json();
        const data = payload.data ?? payload;
        
        if (data.authenticated) {
          currentUser = data.user;
          renderUserBar();
        }
      } catch (err) {
        console.error('Auth check failed:', err);
      }
    }
    
    // Render user bar
    function renderUserBar() {
      const bar = document.getElementById('user-bar');
      
      if (currentUser) {
        bar.className = 'user-bar';
        bar.innerHTML = `
          <div class="user-info">
            Welcome, <strong>${currentUser.firstName}</strong>
          </div>
          <div class="user-actions">
            <a href="user-dashboard" class="btn btn-secondary btn-small">My Applications</a>
            <button onclick="logout()" class="btn btn-small" style="background: var(--color-text-muted); color: var(--color-bg-white);">Log Out</button>
          </div>
        `;
      } else {
        bar.className = 'user-bar logged-out';
        bar.innerHTML = `
          <div class="user-actions">
            <a href="user-login" class="btn btn-secondary btn-small">Log In</a>
            <a href="user-register" class="btn btn-primary btn-small">Create Account</a>
          </div>
        `;
      }
    }
    
    // Logout
    async function logout() {
      try {
        await fetch('/api/v1/user/logout', { method: 'POST' });
        currentUser = null;
        renderUserBar();
      } catch (err) {
        console.error('Logout failed:', err);
      }
    }
    
    // Load roles for filter
    async function loadRoles() {
      try {
        const res = await fetch('/api/v1/jobs/meta/roles');
        const payload = await res.json();
        const roles = payload.data ?? payload;
        
        const select = document.getElementById('filter-role');
        roles.forEach(role => {
          const opt = document.createElement('option');
          opt.value = role.id;
          opt.textContent = role.name;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error('Failed to load roles:', err);
      }
    }
    
    // Load jobs
    async function loadJobs(page = 1) {
      const container = document.getElementById('jobs-container');
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading jobs...</p></div>';
      
      try {
        const params = new URLSearchParams({ page, limit: 20 });
        if (filters.roleId) params.append('roleId', filters.roleId);
        if (filters.type) params.append('type', filters.type);
        
        const res = await fetch(`/api/v1/jobs?${params}`);
        const payload = await res.json();
        const data = payload.data ?? payload;
        
        currentPage = data.pagination.page;
        totalPages = data.pagination.totalPages;
        
        if (data.jobs.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <h3>No jobs available</h3>
              <p>Check back soon for new opportunities!</p>
            </div>
          `;
          document.getElementById('pagination').style.display = 'none';
          return;
        }
        
        container.innerHTML = '<div class="jobs-grid">' + data.jobs.map(renderJobCard).join('') + '</div>';
        renderPagination();
        
      } catch (err) {
        console.error('Failed to load jobs:', err);
        container.innerHTML = '<div class="empty-state"><h3>Failed to load jobs</h3><p>Please try again later.</p></div>';
      }
    }
    
    // Render job card
    function renderJobCard(job) {
      const date = job.eventDate 
        ? new Date(job.eventDate).toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' })
        : 'Flexible';
      
      const time = job.shiftStart && job.shiftEnd 
        ? `${job.shiftStart} - ${job.shiftEnd}` 
        : 'TBC';
      
      const pay = job.payRate 
        ? `¬£${job.payRate}/${job.payType === 'HOURLY' ? 'hr' : job.payType === 'DAILY' ? 'day' : 'fixed'}`
        : 'Competitive';
      
      const spotsClass = job.spotsLeft <= 2 ? 'urgent' : '';
      const typeClass = job.type === 'INTERNAL' ? 'internal' : 'external';
      const typeLabel = job.type === 'INTERNAL' ? 'VERGO' : job.companyName || 'External';
      
      return `
        <div class="job-card">
          <div class="job-header">
            <div>
              <h3 class="job-title">${escapeHtml(job.title)}</h3>
              <span class="job-role">${escapeHtml(job.role.name)}</span>
            </div>
            <span class="job-type ${typeClass}">${escapeHtml(typeLabel)}</span>
          </div>
          
          <div class="job-meta">
            <span>üìç ${escapeHtml(job.location)}</span>
            <span>üìÖ ${date}</span>
            <span>‚è∞ ${time}</span>
          </div>
          
          <p class="job-description">${escapeHtml(job.description)}</p>
          
          <div class="job-footer">
            <div>
              <span class="job-pay">${pay}</span>
              <span class="spots-left ${spotsClass}"> ¬∑ ${job.spotsLeft} spot${job.spotsLeft !== 1 ? 's' : ''} left</span>
            </div>
            <a href="job-detail.html?id=${job.id}" class="btn btn-primary btn-small">View & Apply</a>
          </div>
        </div>
      `;
    }
    
    // Render pagination
    function renderPagination() {
      const container = document.getElementById('pagination');
      
      if (totalPages <= 1) {
        container.style.display = 'none';
        return;
      }
      
      container.style.display = 'flex';
      container.innerHTML = `
        <button onclick="loadJobs(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>‚Üê Previous</button>
        <span class="current">Page ${currentPage} of ${totalPages}</span>
        <button onclick="loadJobs(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>Next ‚Üí</button>
      `;
    }
    
    // Escape HTML
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    // Filter handlers
    document.getElementById('filter-role').addEventListener('change', (e) => {
      filters.roleId = e.target.value;
      loadJobs(1);
    });
    
    document.getElementById('filter-type').addEventListener('change', (e) => {
      filters.type = e.target.value;
      loadJobs(1);
    });
    
    // Init
    checkAuth();
    loadRoles();
    loadJobs();
  </script>
  <script src="/vergo-utils.js"></script>
  <script src="/vergo-nav.js"></script>
  <script src="/vergo-footer.js"></script>
  <script src="/vergo-analytics.js"></script>
<!-- Google Analytics (non-blocking) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-L4XRTDYMTZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-L4XRTDYMTZ');
</script>
</body>
</html>
